# Azure Pipelines documentation https://aka.ms/yaml

trigger:
  branches:
    include:
    - '*'
  tags:
    include:
    - '*'

variables:
  # Set the DOTNET_SKIP_FIRST_TIME_EXPERIENCE environment variable to stop wasting time caching packages
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  # Disable sending usage data to Microsoft
  DOTNET_CLI_TELEMETRY_OPTOUT: true

stages:
- stage: Build
  jobs:
  - job: Build
    strategy:
      matrix:
        Linux:
          matrixName: Ubuntu
          vmImageName: ubuntu-latest
        Mac:
          matrixName: Mac
          vmImageName: macos-latest
        Windows:
          matrixName: Windows
          vmImageName: windows-latest
    pool:
      vmImage: $(vmImageName)
    timeoutInMinutes: 10
    steps:
    - checkout: self
      lfs: true
    - task: UseDotNet@2
      displayName: 'Install .NET Core SDK'
      inputs:
        packageType: 'sdk'
        version: '3.0.100'
    - script: 'dotnet tool install --global Cake.Tool'
      displayName: 'Install Cake Tool'
      failOnStderr: true
    - script: 'dotnet cake --target=Build'
      displayName: 'Dotnet Cake Build'
      failOnStderr: true
    - script: 'dotnet cake --target=Test'
      displayName: 'Dotnet Cake Test'
      failOnStderr: true
    - script: 'dotnet cake --target=Pack'
      displayName: 'Dotnet Cake Pack'
      failOnStderr: true
    - task: PublishTestResults@2
      displayName: 'Publish Test Results'
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/*.trx'
    - publish: './Artefacts'
      artifact: $(matrixName)
      displayName: 'Publish Artefacts'
- stage: Deploy
  jobs:
  - deployment: AzureArtefacts
    displayName: 'Azure Artefacts'
    pool:
      vmImage: windows-latest
    environment: 'Azure Artefacts'
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
          - task: UseDotNet@2
            displayName: 'Install .NET Core SDK'
            inputs:
              packageType: 'sdk'
              version: '3.0.100'
          - task: NuGetToolInstaller@1
            displayName: 'Install NuGet'
          - task: NuGetAuthenticate@0
          - script: 'dotnet tool install --global Cake.Tool'
            displayName: 'Install Cake Tool'
            failOnStderr: true
          - script: 'dotnet cake --target=PushAzureArtefacts --AzureArtefactsOrganization=RehanSaeed --ArtefactsDirectoryPath=$(Agent.BuildDirectory)/Windows --Verbosity=Diagnostic'
            displayName: 'Dotnet Cake PushAzureArtefacts'
            failOnStderr: true
  - deployment: GitHub
    pool:
      vmImage: windows-latest
    environment: 'GitHub'
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
          - task: UseDotNet@2
            displayName: 'Install .NET Core SDK'
            inputs:
              packageType: 'sdk'
              version: '3.0.100'
          - task: NuGetToolInstaller@1
            displayName: 'Install NuGet'
          - script: 'dotnet tool install --global Cake.Tool'
            displayName: 'Install Cake Tool'
            failOnStderr: true
          - script: 'dotnet cake --target=PushGitHub --GitHubUserName=$(GitHubUserName) --GitHubPassword=$(GitHubPersonalAccessToken) --ArtefactsDirectoryPath=$(Agent.BuildDirectory)/Windows --Verbosity=Diagnostic'
            displayName: 'Dotnet Cake PushGitHub'
            failOnStderr: true
  - deployment: NuGet
    pool:
      vmImage: windows-latest
    environment: 'NuGet'
    condition: startsWith(variables['Build.sourceBranch'], 'refs/tags/')
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
          - task: UseDotNet@2
            displayName: 'Install .NET Core SDK'
            inputs:
              packageType: 'sdk'
              version: '3.0.100'
          - task: NuGetToolInstaller@1
            displayName: 'Install NuGet'
          - script: 'dotnet tool install --global Cake.Tool'
            displayName: 'Install Cake Tool'
            failOnStderr: true
          - script: 'dotnet cake --target=PushNuGet --NuGetApiKey=$(NuGetApiKey) --ArtefactsDirectoryPath=$(Agent.BuildDirectory)/Windows --Verbosity=Diagnostic'
            displayName: 'Dotnet Cake PushNuGet'
            failOnStderr: true
